<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FixieRun - Move to Earn </title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#5D5CDE">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FixieRun">
    
    <!-- Performance & Security -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="format-detection" content="telephone=no">
    <link href="/fixierun-pwa/assets/tailwind.css" rel="stylesheet">
    <link rel="preconnect" href="https://kit.fontawesome.com">
    <link rel="preconnect" href="https://unpkg.com">
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
    
    <!-- CSS Libraries -->
    
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- GPS Map - Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Le reste de ton CSS reste identique... -->
    <!-- [Coller tout ton CSS existant ici] --> 

</head>
<body class="h-full bg-bg-light dark:bg-bg-dark text-gray-900 dark:text-white transition-colors duration-300 safe-top safe-bottom">
    
    <!-- Ton HTML body reste identique... -->
    <!-- [Coller tout ton HTML body existant ici] -->
     
    <script>
        // Modifier la classe FixieRunPWA
        class FixieRunPWA {
            constructor() {
                // Ton state reste identique
                this.state = {
                    // ... ton state existant
                };
                
                this.watchId = null;
                this.workoutInterval = null;
                this.map = null;
                this.marker = null;
                this.path = null;
                this.wakeLock = null;
                this.charts = {};
                
                this.init();
            }

            async init() {
                this.setupTheme();
                this.setupEventListeners();
                this.updateConnectionStatus();
                this.loadUserData();
                this.setupPWA();
                
                // Initialize GPS
                await this.requestGPSPermission();
                
                // Initialize charts
                this.initializeCharts();
                
                // Update all UIs
                this.updateAllUIs();
            }

            setupPWA() {
                // Register service worker
                this.registerServiceWorker();
                
                // Handle install prompt
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    this.showInstallPrompt = e;
                });
                
                // Handle PWA installed
                window.addEventListener('appinstalled', () => {
                    this.showNotification('success', 'App Installed!', 'FixieRun is now installed on your device');
                });
            }

            // Service Worker amélioré
            async registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    try {
                        const registration = await navigator.serviceWorker.register('./sw.js', {
                            scope: './'
                        });
                        console.log('✅ Service Worker registered successfully');
                        
                        // Gérer les mises à jour
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    this.showNotification('info', 'Update Available', 'Refresh to get the latest version');
                                }
                            });
                        });
                        
                    } catch (error) {
                        console.log('❌ Service Worker registration failed:', error);
                    }
                }
            }
            
            // GPS Permissions amélioré
            async requestGPSPermission() {
                try {
                    // Vérifier si les permissions sont supportées
                    if ('permissions' in navigator) {
                        const result = await navigator.permissions.query({name: 'geolocation'});
                        
                        switch(result.state) {
                            case 'granted':
                                this.initializeGPS();
                                break;
                            case 'prompt':
                                // L'utilisateur sera sollicité lors de getCurrentPosition
                                this.initializeGPS();
                                break;
                            case 'denied':
                                this.showNotification('error', 'GPS Denied', 'Please enable location access in browser settings');
                                break;
                        }
                        
                        // Écouter les changements de permission
                        result.addEventListener('change', () => {
                            if (result.state === 'granted') {
                                this.initializeGPS();
                            } else if (result.state === 'denied') {
                                this.handleGPSError(new Error('Permission denied'));
                            }
                        });
                    } else {
                        // Fallback pour les navigateurs plus anciens
                        this.initializeGPS();
                    }
                } catch (error) {
                    console.error('Permission API not supported:', error);
                    this.initializeGPS();
                }
            }

            // Reste de tes méthodes identiques...
            // [Coller toutes tes autres méthodes existantes ici]
        }

        // Initialize the complete PWA
        document.addEventListener('DOMContentLoaded', () => {
            window.fixieApp = new FixieRunPWA();
        // Préchargement intelligent
if ('requestIdleCallback' in window) {
  requestIdleCallback(() => {
    // Précharger les tuiles de carte de la région
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(position => {
        const { latitude, longitude } = position.coords;
        preloadMapTiles(latitude, longitude, 13, 2); // zoom 13, rayon 2km
      });
    }
  });
}

// Optimisation mémoire
window.addEventListener('beforeunload', () => {
  // Nettoyer les listeners GPS
  if (window.watchId) {
    navigator.geolocation.clearWatch(window.watchId);
  }
});

</script>

</body>
</html>
